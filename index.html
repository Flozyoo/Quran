<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hub de Contr√¥les : Math√©matiques</title>
    
    <!-- Tailwind CSS for rapid styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- MathJax Configuration -->
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$']]
      },
      svg: {
        fontCache: 'global'
      }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* A4 Paper Simulation */
        .paper {
            background-color: white;
            width: 100%;
            max-width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 15mm;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            position: relative;
        }

        /* Print adjustments */
        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            .paper { box-shadow: none; margin: 0; padding: 10mm; width: 100%; max-width: none; }
        }

        /* Mobile adjustments */
        @media (max-width: 640px) {
            .paper { padding: 15px; width: 100%; min-height: 100vh; }
        }

        /* Transition effects */
        .fade-enter { opacity: 0; }
        .fade-enter-active { opacity: 1; transition: opacity 300ms; }
        
        /* Custom Scrollbar for Menu */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-600 font-serif text-gray-900 min-h-screen flex flex-col items-center py-4 sm:py-8">

    <!-- LOADING SPINNER -->
    <div id="loader" class="fixed inset-0 bg-gray-800 bg-opacity-90 z-50 flex items-center justify-center text-white">
        <div class="text-center">
            <i class="fas fa-circle-notch fa-spin text-4xl mb-4"></i>
            <p>Chargement des sujets...</p>
        </div>
    </div>

    <!-- MAIN EXAM CONTAINER -->
    <div id="exam-container" class="paper hidden">
        <!-- Content injected via JS -->
    </div>

    <!-- EMPTY STATE -->
    <div id="empty-state" class="hidden text-white text-center mt-20">
        <i class="fas fa-folder-open text-6xl mb-4 text-gray-400"></i>
        <p class="text-xl">Aucun sujet disponible.</p>
        <p class="text-sm text-gray-400">Connectez-vous en admin pour en cr√©er un.</p>
    </div>

    <!-- FAB MENU (Floating Action Button) -->
    <div class="fixed bottom-6 right-6 z-40 no-print flex flex-col items-end gap-3">
        
        <!-- Menu List (Hidden by default) -->
        <div id="fab-menu" class="bg-white rounded-lg shadow-xl p-2 w-64 transform scale-0 origin-bottom-right transition-transform duration-200 ease-out mb-2 max-h-[70vh] flex flex-col">
            <div class="p-2 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t">
                <span class="font-bold text-gray-700 text-sm">Sujets Disponibles</span>
                <button onclick="toggleAdminPanel()" class="text-gray-400 hover:text-blue-600 transition p-1" title="Administration">
                    <i class="fas fa-lock"></i>
                </button>
            </div>
            
            <div id="subject-list" class="flex-1 overflow-y-auto custom-scroll p-1 space-y-1">
                <!-- List items injected here -->
            </div>

            <!-- Admin Add Button (Only visible if admin) -->
            <button id="btn-add-new" class="hidden w-full mt-2 bg-green-600 hover:bg-green-700 text-white py-2 rounded text-sm font-bold items-center justify-center gap-2 transition" onclick="openEditor()">
                <i class="fas fa-plus"></i> Nouveau Sujet
            </button>
        </div>

        <!-- Main FAB Button -->
        <button onclick="toggleMenu()" class="bg-blue-600 hover:bg-blue-700 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-xl transition-transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-4 focus:ring-blue-300">
            <i class="fas fa-bars" id="fab-icon"></i>
        </button>
    </div>

    <!-- ADMIN AUTH MODAL -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center px-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-center">Acc√®s Professeur</h3>
            <input type="password" id="admin-pin" placeholder="Code PIN (9090)" class="w-full border p-3 rounded mb-4 text-center text-lg tracking-widest focus:ring-2 focus:ring-blue-500 outline-none" inputmode="numeric">
            <div class="flex gap-2">
                <button onclick="closeModals()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded transition">Annuler</button>
                <button onclick="verifyPin()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded transition font-bold">Entrer</button>
            </div>
        </div>
    </div>

    <!-- EDITOR MODAL -->
    <div id="editor-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex flex-col">
        <div class="bg-gray-800 text-white p-4 flex justify-between items-center shadow-md">
            <h3 class="font-bold text-lg"><i class="fas fa-edit mr-2"></i>√âditeur de Sujet</h3>
            <button onclick="closeModals()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
        </div>
        
        <div class="flex-1 flex flex-col md:flex-row bg-white overflow-hidden">
            <!-- Left: Inputs -->
            <div class="w-full md:w-1/2 p-4 flex flex-col border-r border-gray-200 bg-gray-50">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Titre du Sujet</label>
                    <input type="text" id="edit-title" class="w-full border border-gray-300 p-2 rounded focus:border-blue-500 outline-none" placeholder="Ex: Sujet B : Analyse">
                </div>
                
                <div class="flex-1 flex flex-col">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1 flex justify-between">
                        <span>Code HTML (Corps du devoir)</span>
                        <span class="text-xs font-normal normal-case text-blue-600 cursor-pointer hover:underline" onclick="insertTemplate()">Ins√©rer Template</span>
                    </label>
                    <textarea id="edit-content" class="flex-1 w-full border border-gray-300 p-2 rounded font-mono text-sm focus:border-blue-500 outline-none resize-none" placeholder="<div class='exercise'>...</div>"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Utilisez $...$ pour les maths en ligne et $$...$$ pour les blocs.</p>
                </div>
            </div>

            <!-- Right: Preview (Hidden on small mobile until toggled, but visible here for simplicity) -->
            <div class="hidden md:block w-1/2 bg-gray-100 overflow-y-auto p-8 flex justify-center">
                <div id="live-preview" class="bg-white shadow p-8 w-full min-h-[500px] text-sm transform scale-90 origin-top">
                    <!-- Preview renders here -->
                </div>
            </div>
        </div>

        <div class="bg-gray-800 p-4 flex justify-between items-center">
            <button onclick="deleteCurrentSubject()" id="btn-delete" class="text-red-400 hover:text-red-300 text-sm font-bold px-4">
                <i class="fas fa-trash"></i> Supprimer
            </button>
            <div class="flex gap-3">
                <button onclick="closeModals()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded transition">Annuler</button>
                <button onclick="saveSubject()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded font-bold shadow-lg transition transform hover:scale-105">
                    <i class="fas fa-save mr-2"></i> Publier
                </button>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl z-50 transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none">
        <span id="toast-msg">Notification</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Configuration ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = __app_id || 'default-math-app';
        const COLLECTION_NAME = 'exams';

        // --- State ---
        let subjects = [];
        let currentSubjectId = null;
        let isAdmin = false;
        let unsubscribe = null;

        // --- DOM Elements ---
        const elLoader = document.getElementById('loader');
        const elContainer = document.getElementById('exam-container');
        const elEmpty = document.getElementById('empty-state');
        const elFabMenu = document.getElementById('fab-menu');
        const elSubjectList = document.getElementById('subject-list');
        const elFabIcon = document.getElementById('fab-icon');
        const elAuthModal = document.getElementById('auth-modal');
        const elEditorModal = document.getElementById('editor-modal');
        const elEditTitle = document.getElementById('edit-title');
        const elEditContent = document.getElementById('edit-content');
        const elBtnAdd = document.getElementById('btn-add-new');

        // --- Initialization ---
        async function init() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                     // For specialized environments
                } else {
                    await signInAnonymously(auth);
                }

                // Listen to Realtime Updates
                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME), 
                    orderBy('title') // Simple sort
                );

                unsubscribe = onSnapshot(q, (snapshot) => {
                    subjects = [];
                    snapshot.forEach(doc => {
                        subjects.push({ id: doc.id, ...doc.data() });
                    });
                    
                    renderMenu();
                    
                    // Logic to select first exam if none selected, or refresh current
                    if (subjects.length > 0) {
                        if (!currentSubjectId || !subjects.find(s => s.id === currentSubjectId)) {
                            loadExam(subjects[0].id); // Load first by default
                        } else {
                            loadExam(currentSubjectId); // Refresh current
                        }
                        elEmpty.classList.add('hidden');
                        elContainer.classList.remove('hidden');
                    } else {
                        elEmpty.classList.remove('hidden');
                        elContainer.classList.add('hidden');
                    }
                    
                    elLoader.classList.add('hidden');
                }, (error) => {
                    console.error("Error fetching data:", error);
                    showToast("Erreur de connexion", true);
                });

            } catch (err) {
                console.error("Init failed", err);
                showToast("Erreur d'initialisation", true);
            }
        }

        // --- Core UI Functions ---

        window.loadExam = (id) => {
            currentSubjectId = id;
            const subject = subjects.find(s => s.id === id);
            if (!subject) return;

            // Highlight in menu
            document.querySelectorAll('.subject-btn').forEach(btn => {
                if(btn.dataset.id === id) {
                    btn.classList.add('bg-blue-100', 'text-blue-700', 'font-bold');
                    btn.classList.remove('text-gray-600', 'hover:bg-gray-100');
                } else {
                    btn.classList.remove('bg-blue-100', 'text-blue-700', 'font-bold');
                    btn.classList.add('text-gray-600', 'hover:bg-gray-100');
                }
            });

            // Inject HTML
            elContainer.innerHTML = `
                <header class="border-2 border-black p-4 text-center mb-8">
                    <h1 class="text-2xl font-bold uppercase mb-2">${subject.title}</h1>
                    <div class="flex flex-wrap justify-between text-sm gap-2">
                        <span class="w-full sm:w-auto text-left"><strong>Niveau :</strong> T.C.S.F</span>
                        <span class="w-full sm:w-auto text-left"><strong>Dur√©e :</strong> 120 Minutes</span>
                        <span class="w-full sm:w-auto text-left"><strong>Professeur :</strong> DALHI Hamid</span>
                        <span class="w-full sm:w-auto text-left"><strong>Ann√©e :</strong> 2024/2025</span>
                    </div>
                    <div class="mt-2 pt-1 border-t border-black w-full text-center font-bold">
                        Note : ......... / 20
                    </div>
                </header>
                <div class="content-body text-justify leading-relaxed">
                    ${subject.content}
                </div>
                <p class="text-center mt-12 italic text-gray-500 text-sm">Fin du ${subject.title}</p>
            `;

            // Trigger MathJax
            if (window.MathJax) {
                window.MathJax.typesetPromise([elContainer]);
            }
            
            // On mobile, close menu after selection
            if(window.innerWidth < 640) {
                closeMenu();
            }
        };

        function renderMenu() {
            elSubjectList.innerHTML = '';
            subjects.forEach(sub => {
                const btn = document.createElement('button');
                btn.className = 'subject-btn w-full text-left px-3 py-2 rounded text-sm transition flex justify-between items-center group';
                btn.dataset.id = sub.id;
                btn.onclick = () => loadExam(sub.id);
                
                const label = document.createElement('span');
                label.innerText = sub.title;
                
                const editIcon = document.createElement('i');
                editIcon.className = `fas fa-cog text-gray-300 hover:text-blue-500 opacity-0 group-hover:opacity-100 transition ${isAdmin ? 'opacity-100' : ''}`;
                editIcon.onclick = (e) => {
                    e.stopPropagation();
                    openEditor(sub.id);
                };

                btn.appendChild(label);
                if(isAdmin) btn.appendChild(editIcon); // Only show gear if admin
                
                elSubjectList.appendChild(btn);
            });
        }

        // --- Menu Logic ---

        window.toggleMenu = () => {
            const isOpen = elFabMenu.classList.contains('scale-100');
            if (isOpen) {
                closeMenu();
            } else {
                elFabMenu.classList.remove('scale-0');
                elFabMenu.classList.add('scale-100');
                elFabIcon.classList.remove('fa-bars');
                elFabIcon.classList.add('fa-times');
            }
        };

        function closeMenu() {
            elFabMenu.classList.add('scale-0');
            elFabMenu.classList.remove('scale-100');
            elFabIcon.classList.add('fa-bars');
            elFabIcon.classList.remove('fa-times');
        }

        // --- Admin & Security Logic ---

        window.toggleAdminPanel = () => {
            if (isAdmin) {
                // If already admin, act as toggle off (logout)
                isAdmin = false;
                elBtnAdd.classList.add('hidden');
                showToast("Mode Administrateur d√©sactiv√©");
                renderMenu();
            } else {
                elAuthModal.classList.remove('hidden');
                document.getElementById('admin-pin').value = '';
                document.getElementById('admin-pin').focus();
            }
        };

        window.verifyPin = () => {
            const pin = document.getElementById('admin-pin').value;
            if (pin === "9090") {
                isAdmin = true;
                elAuthModal.classList.add('hidden');
                elBtnAdd.classList.remove('hidden');
                showToast("üîì Mode Professeur Activ√©");
                renderMenu(); // Re-render to show edit icons
            } else {
                showToast("Code PIN Incorrect", true);
                document.getElementById('admin-pin').value = '';
            }
        };

        // --- Editor Logic ---

        let editingId = null;

        window.openEditor = (id = null) => {
            if (!isAdmin) {
                toggleAdminPanel();
                return;
            }

            editingId = id;
            elEditorModal.classList.remove('hidden');
            
            const deleteBtn = document.getElementById('btn-delete');

            if (id) {
                // Edit mode
                const sub = subjects.find(s => s.id === id);
                elEditTitle.value = sub.title;
                elEditContent.value = sub.content;
                deleteBtn.classList.remove('hidden');
            } else {
                // Create mode
                elEditTitle.value = "Nouveau Sujet";
                insertTemplate(); // Pre-fill with template
                deleteBtn.classList.add('hidden');
            }
            closeMenu();
        };

        window.insertTemplate = () => {
            elEditContent.value = `
<div class="mb-6">
    <div class="flex justify-between items-center border-b border-black pb-1 mb-3">
        <span class="font-bold text-lg">Exercice 1 : Titre</span>
        <span class="font-bold">(5 pts)</span>
    </div>
    <ul class="list-disc pl-5 space-y-2">
        <li>Calculer l'expression : $A = \\sqrt{25} + 3^2$</li>
        <li>R√©soudre l'√©quation : $$x^2 - 4x + 3 = 0$$</li>
    </ul>
</div>

<div class="mb-6">
    <div class="flex justify-between items-center border-b border-black pb-1 mb-3">
        <span class="font-bold text-lg">Exercice 2 : G√©om√©trie</span>
        <span class="font-bold">(5 pts)</span>
    </div>
    <p>Soit $ABC$ un triangle rectangle en $A$.</p>
</div>`;
        };

        window.closeModals = () => {
            elAuthModal.classList.add('hidden');
            elEditorModal.classList.add('hidden');
            editingId = null;
        };

        window.saveSubject = async () => {
            const title = elEditTitle.value;
            const content = elEditContent.value;

            if (!title || !content) {
                showToast("Veuillez remplir tous les champs", true);
                return;
            }

            showToast("Sauvegarde en cours...");

            try {
                if (editingId) {
                    // Update
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, editingId);
                    await updateDoc(docRef, {
                        title: title,
                        content: content
                    });
                } else {
                    // Create
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME), {
                        title: title,
                        content: content,
                        createdAt: serverTimestamp()
                    });
                }
                
                showToast("Sujet sauvegard√© !");
                closeModals();
            } catch (error) {
                console.error(error);
                showToast("Erreur lors de la sauvegarde", true);
            }
        };

        window.deleteCurrentSubject = async () => {
            if (!editingId) return;
            if(!confirm("√ätes-vous s√ªr de vouloir supprimer ce sujet d√©finitivement ?")) return;

            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, editingId));
                showToast("Sujet supprim√©");
                closeModals();
                // Reset view
                if(subjects.length > 0) loadExam(subjects[0].id);
            } catch (error) {
                console.error(error);
                showToast("Erreur lors de la suppression", true);
            }
        }

        // --- Utilities ---

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-msg');
            toastMsg.innerText = msg;
            
            if (isError) {
                toast.classList.remove('bg-gray-800');
                toast.classList.add('bg-red-600');
            } else {
                toast.classList.add('bg-gray-800');
                toast.classList.remove('bg-red-600');
            }

            toast.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-[-20px]');
            }, 3000);
        }

        // Start
        init();

    </script>
</body>
</html>

