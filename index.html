<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hub de Contrôles : Mathématiques</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$']] },
      svg: { fontCache: 'global' }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        .paper { background-color: white; width: 100%; max-width: 210mm; min-height: 297mm; margin: 0 auto; padding: 15mm; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        @media print { body { background: white; padding: 0; } .no-print { display: none !important; } .paper { box-shadow: none; margin: 0; padding: 10mm; width: 100%; max-width: none; } }
        @media (max-width: 640px) { .paper { padding: 15px; width: 100%; } }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-800 font-serif text-gray-900 min-h-screen flex flex-col items-center py-4 sm:py-8">

    <!-- LOADER -->
    <div id="loader" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center text-white">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mb-4 mx-auto"></div>
            <p>Connexion à Math-Hub Cloud...</p>
        </div>
    </div>

    <!-- MAIN PAPER -->
    <div id="exam-container" class="paper hidden"></div>

    <!-- EMPTY STATE -->
    <div id="empty-state" class="hidden text-white text-center mt-20">
        <i class="fas fa-folder-open text-6xl mb-4 text-gray-500"></i>
        <p class="text-xl">Aucun sujet trouvé.</p>
        <button onclick="toggleAdminPanel()" class="mt-4 text-blue-400 hover:underline">Accès Professeur</button>
    </div>

    <!-- FAB MENU -->
    <div class="fixed bottom-6 right-6 z-40 no-print flex flex-col items-end gap-3">
        <div id="fab-menu" class="bg-white rounded-lg shadow-xl p-2 w-64 transform scale-0 origin-bottom-right transition-transform duration-200 mb-2 flex flex-col overflow-hidden">
            <div class="p-2 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t">
                <span class="font-bold text-gray-700 text-sm">Sujets Enregistrés</span>
                <div class="flex gap-2">
                    <button onclick="window.print()" class="text-gray-500 hover:text-green-600"><i class="fas fa-print"></i></button>
                    <button onclick="toggleAdminPanel()" id="admin-lock-btn" class="text-gray-400"><i class="fas fa-lock"></i></button>
                </div>
            </div>
            <div id="subject-list" class="max-h-60 overflow-y-auto custom-scroll p-1 space-y-1"></div>
            <button id="btn-add-new" class="hidden w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded text-sm font-bold flex items-center justify-center gap-2 transition" onclick="openEditor()">
                <i class="fas fa-plus"></i> Nouveau Sujet
            </button>
        </div>
        <button onclick="toggleMenu()" class="bg-blue-600 hover:bg-blue-700 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-xl transition-transform hover:scale-105">
            <i class="fas fa-bars" id="fab-icon"></i>
        </button>
    </div>

    <!-- MODAL AUTH -->
    <div id="auth-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center px-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-center">Authentification Professeur</h3>
            <input type="password" id="admin-pin" placeholder="PIN" class="w-full border p-3 rounded mb-4 text-center text-2xl tracking-[1em] focus:ring-2 focus:ring-blue-500 outline-none">
            <div class="flex gap-2">
                <button onclick="closeModals()" class="flex-1 bg-gray-100 py-2 rounded">Annuler</button>
                <button onclick="verifyPin()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold">Valider</button>
            </div>
        </div>
    </div>

    <!-- EDITOR MODAL -->
    <div id="editor-modal" class="fixed inset-0 bg-white z-50 hidden flex flex-col">
        <div class="bg-gray-800 text-white p-4 flex justify-between items-center">
            <h3 class="font-bold">Éditeur de Sujet</h3>
            <div class="flex gap-4">
                <button onclick="deleteCurrentSubject()" id="btn-delete" class="text-red-400 text-sm font-bold hidden"><i class="fas fa-trash"></i></button>
                <button onclick="closeModals()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
        </div>
        <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
            <div class="w-full md:w-1/2 p-4 flex flex-col border-r bg-gray-50 overflow-y-auto">
                <input type="text" id="edit-title" class="w-full border p-2 rounded mb-4 font-bold" placeholder="Titre de l'épreuve">
                <div class="flex justify-between items-center mb-1">
                    <label class="text-xs font-bold text-gray-500 uppercase">Contenu (LaTeX supporté)</label>
                    <button onclick="insertTemplate()" class="text-blue-600 text-xs hover:underline">Charger modèle</button>
                </div>
                <textarea id="edit-content" class="flex-1 w-full border p-2 rounded font-mono text-sm min-h-[300px]" placeholder="Utilisez $...$ pour les formules mathématiques"></textarea>
            </div>
            <div class="hidden md:block w-1/2 bg-gray-200 p-4 overflow-y-auto">
                <div class="bg-white shadow p-8 min-h-full" id="live-preview"></div>
            </div>
        </div>
        <div class="p-4 bg-gray-100 flex justify-end">
            <button onclick="saveSubject()" class="bg-green-600 hover:bg-green-700 text-white px-12 py-3 rounded-lg font-bold shadow-lg transition">PUBLIER L'EXAMEN</button>
        </div>
    </div>

    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl z-[60] opacity-0 transition-opacity pointer-events-none"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // CONFIGURATION CONNECTÉE
        const firebaseConfig = {
            apiKey: "AIzaSyCWUIfZWinb7m5-gDaDjDsjgezxMFCkjzs",
            authDomain: "math-hub-832fb.firebaseapp.com",
            projectId: "math-hub-832fb",
            storageBucket: "math-hub-832fb.firebasestorage.app",
            messagingSenderId: "201853249740",
            appId: "1:201853249740:web:f0ce27947e83687020ba69",
            measurementId: "G-MEBTLZPD1P"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'math-hub-v1';

        let subjects = [];
        let currentSubjectId = null;
        let isAdmin = false;
        let user = null;

        const elLoader = document.getElementById('loader');
        const elContainer = document.getElementById('exam-container');
        const elEmpty = document.getElementById('empty-state');
        const elSubjectList = document.getElementById('subject-list');
        const elEditContent = document.getElementById('edit-content');
        const elLivePreview = document.getElementById('live-preview');

        async function init() {
            try {
                // Règle 3 : Auth d'abord
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) startListener();
                });
            } catch (e) { 
                console.error(e);
                showToast("Erreur d'authentification Firebase", true); 
            }
        }

        function startListener() {
            // Règle 1 : Chemins stricts
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'exams'), orderBy('createdAt', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                subjects = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderMenu();
                
                if (subjects.length > 0) {
                    elEmpty.classList.add('hidden');
                    elContainer.classList.remove('hidden');
                    if (!currentSubjectId) loadExam(subjects[0].id);
                } else {
                    elEmpty.classList.remove('hidden');
                    elContainer.classList.add('hidden');
                }
                elLoader.classList.add('hidden');
            }, (err) => { 
                console.error(err);
                showToast("Erreur: Vérifiez vos règles Firestore", true); 
            });
        }

        window.toggleMenu = () => {
            const menu = document.getElementById('fab-menu');
            const icon = document.getElementById('fab-icon');
            const isOpen = menu.classList.contains('scale-100');
            menu.classList.toggle('scale-100', !isOpen);
            menu.classList.toggle('scale-0', isOpen);
            icon.className = isOpen ? 'fas fa-bars' : 'fas fa-times';
        };

        window.loadExam = (id) => {
            currentSubjectId = id;
            const sub = subjects.find(s => s.id === id);
            if (!sub) return;

            elContainer.innerHTML = `
                <div class="border-2 border-black p-4 text-center mb-8">
                    <h1 class="text-2xl font-bold uppercase mb-2">${sub.title}</h1>
                    <div class="grid grid-cols-2 text-left text-sm gap-2">
                        <span><strong>Niveau:</strong> Tronc Commun Sc</span>
                        <span><strong>Durée:</strong> 2 Heures</span>
                        <span><strong>Professeur:</strong> Prof. Hamid</span>
                        <span><strong>Session:</strong> 2024/2025</span>
                    </div>
                </div>
                <div class="exam-content text-lg leading-relaxed">${sub.content}</div>
                <p class="text-center mt-12 italic text-gray-400 border-t pt-4">Fin de l'épreuve - Bonne chance</p>
            `;
            
            if (window.MathJax) window.MathJax.typesetPromise([elContainer]);
            renderMenu();
        };

        window.renderMenu = () => {
            elSubjectList.innerHTML = '';
            subjects.forEach(s => {
                const active = s.id === currentSubjectId;
                const btn = document.createElement('div');
                btn.className = `flex items-center justify-between p-2 rounded cursor-pointer transition ${active ? 'bg-blue-100 text-blue-800 font-bold' : 'hover:bg-gray-100'}`;
                btn.innerHTML = `
                    <span class="truncate flex-1" onclick="loadExam('${s.id}')">${s.title}</span>
                    ${isAdmin ? `<button onclick="openEditor('${s.id}')" class="ml-2 text-blue-500"><i class="fas fa-edit"></i></button>` : ''}
                `;
                elSubjectList.appendChild(btn);
            });
        };

        window.toggleAdminPanel = () => {
            if (isAdmin) {
                isAdmin = false;
                document.getElementById('btn-add-new').classList.add('hidden');
                document.getElementById('admin-lock-btn').innerHTML = '<i class="fas fa-lock"></i>';
                renderMenu();
                showToast("Déconnecté");
            } else {
                document.getElementById('auth-modal').classList.remove('hidden');
            }
        };

        window.verifyPin = () => {
            if (document.getElementById('admin-pin').value === "9090") {
                isAdmin = true;
                document.getElementById('auth-modal').classList.add('hidden');
                document.getElementById('btn-add-new').classList.remove('hidden');
                document.getElementById('admin-lock-btn').innerHTML = '<i class="fas fa-unlock text-blue-600"></i>';
                renderMenu();
                showToast("Accès autorisé");
                document.getElementById('admin-pin').value = '';
            } else {
                showToast("PIN Incorrect", true);
            }
        };

        window.openEditor = (id = null) => {
            currentSubjectId = id;
            const sub = id ? subjects.find(s => s.id === id) : { title: '', content: '' };
            document.getElementById('edit-title').value = sub.title;
            elEditContent.value = sub.content;
            document.getElementById('btn-delete').classList.toggle('hidden', !id);
            document.getElementById('editor-modal').classList.remove('hidden');
            updatePreview();
        };

        window.closeModals = () => {
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('editor-modal').classList.add('hidden');
        };

        function updatePreview() {
            elLivePreview.innerHTML = elEditContent.value;
            if (window.MathJax) window.MathJax.typesetPromise([elLivePreview]);
        }
        elEditContent.addEventListener('input', updatePreview);

        window.insertTemplate = () => {
            elEditContent.value = `<div class="mb-6">
  <h3 class="font-bold border-b-2 border-black mb-2 flex justify-between">
    <span>Exercice 1</span> <span>(5 pts)</span>
  </h3>
  <p>Soit l'expression $E = (x+3)^2 - 4$.</p>
  <ul class="list-disc ml-8 mt-2">
    <li>Développer et réduire $E$.</li>
    <li>Calculer $E$ pour $x = \\sqrt{2}$.</li>
    <li>Factoriser $E$.</li>
  </ul>
</div>`;
            updatePreview();
        };

        window.saveSubject = async () => {
            if (!user) return;
            const data = {
                title: document.getElementById('edit-title').value || "Sujet sans titre",
                content: elEditContent.value,
                updatedAt: serverTimestamp()
            };

            try {
                if (currentSubjectId && subjects.find(s => s.id === currentSubjectId)) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'exams', currentSubjectId), data);
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'exams'), data);
                }
                showToast("Enregistré avec succès !");
                closeModals();
            } catch (e) { showToast("Erreur d'écriture", true); }
        };

        window.deleteCurrentSubject = async () => {
            if (!currentSubjectId || !confirm("Supprimer ce sujet définitivement ?")) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'exams', currentSubjectId));
                showToast("Sujet supprimé");
                currentSubjectId = null;
                closeModals();
            } catch (e) { showToast("Erreur de suppression", true); }
        };

        function showToast(m, err = false) {
            const t = document.getElementById('toast');
            t.innerText = m;
            t.classList.toggle('bg-red-600', err);
            t.classList.toggle('bg-blue-600', !err);
            t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 3000);
        }

        init();
    </script>
</body>
</html>

