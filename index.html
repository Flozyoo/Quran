import React, { useState, useEffect, useRef } from 'react';
import { createRoot } from 'react-dom/client';

// --- Icons (Inline SVGs to prevent loading errors) ---
const Icons = {
  Camera: () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
  ),
  Download: () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
  ),
  Code: () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
  ),
  Palette: () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="13.5" cy="6.5" r=".5" fill="currentColor"></circle><circle cx="17.5" cy="10.5" r=".5" fill="currentColor"></circle><circle cx="8.5" cy="7.5" r=".5" fill="currentColor"></circle><circle cx="6.5" cy="12.5" r=".5" fill="currentColor"></circle><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"></path></svg>
  ),
  Type: () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>
  ),
  Layout: () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
  ),
  Loader: () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
  ),
  ChevronDown: () => (
    <svg width="10" height="6" viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1L5 5L9 1" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/></svg>
  )
};

const App = () => {
  // --- State ---
  const [code, setCode] = useState(`// Welcome to CodeSnap!
// Type here to edit...

function isAwesome(app) {
  if (app === 'Code Snap') {
    return true;
  }
  return 'Maybe';
}`);
  const [language, setLanguage] = useState('javascript');
  const [background, setBackground] = useState('bg-gradient-to-br from-pink-500 via-purple-500 to-indigo-500');
  const [title, setTitle] = useState('script.js');
  const [darkMode, setDarkMode] = useState(true);
  const [padding, setPadding] = useState('p-12');
  const [isExporting, setIsExporting] = useState(false);
  const [scriptsLoaded, setScriptsLoaded] = useState(false);

  const captureRef = useRef(null);

  // --- Constants ---
  const languages = [
    { id: 'javascript', name: 'JavaScript' },
    { id: 'python', name: 'Python' },
    { id: 'css', name: 'CSS' },
    { id: 'html', name: 'HTML' },
    { id: 'java', name: 'Java' },
    { id: 'cpp', name: 'C++' },
    { id: 'sql', name: 'SQL' },
    { id: 'typescript', name: 'TypeScript' },
    { id: 'json', name: 'JSON' },
  ];

  const backgrounds = [
    { name: 'Cotton Candy', class: 'bg-gradient-to-br from-pink-500 via-purple-500 to-indigo-500' },
    { name: 'Midnight', class: 'bg-gradient-to-br from-gray-900 via-purple-900 to-violet-600' },
    { name: 'Sunset', class: 'bg-gradient-to-br from-orange-400 via-red-500 to-pink-500' },
    { name: 'Ocean', class: 'bg-gradient-to-br from-cyan-400 via-blue-500 to-indigo-500' },
    { name: 'Forest', class: 'bg-gradient-to-br from-emerald-400 via-green-500 to-teal-600' },
    { name: 'Minimal', class: 'bg-gray-200' },
  ];

  const paddings = [
    { name: 'Compact', class: 'p-4' },
    { name: 'Normal', class: 'p-8' },
    { name: 'Wide', class: 'p-16' },
  ];

  // --- Effects ---
  
  // 1. Load Scripts Manually
  useEffect(() => {
    const loadScript = (src) => {
      return new Promise((resolve, reject) => {
        if (document.querySelector(`script[src="${src}"]`)) {
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.src = src;
        script.async = true;
        script.onload = resolve;
        script.onerror = reject;
        document.body.appendChild(script);
      });
    };

    const loadAll = async () => {
      try {
        await loadScript("https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js");
        // Load languages
        const langs = [
            "javascript", "python", "css", "java", "cpp", "sql", "typescript", "json"
        ];
        // Load languages sequentially or parallel, simpler to just fire and forget mostly
        // but Prism needs core first.
        await Promise.all(langs.map(l => loadScript(`https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-${l}.min.js`)));
        await loadScript("https://html2canvas.hertzen.com/dist/html2canvas.min.js");
        
        setScriptsLoaded(true);
      } catch (e) {
        console.error("Script load error", e);
      }
    };

    loadAll();
  }, []);

  // 2. Highlight when code/lang changes
  useEffect(() => {
    if (scriptsLoaded && window.Prism) {
      window.Prism.highlightAll();
    }
  }, [code, language, scriptsLoaded]);

  // --- Handlers ---
  const handleExport = async () => {
    if (!scriptsLoaded || !window.html2canvas) {
      alert("Export tools are still loading. Please wait a moment.");
      return;
    }
    
    setIsExporting(true);
    if (captureRef.current) {
      try {
        const canvas = await window.html2canvas(captureRef.current, {
          scale: 2, // Retina quality
          backgroundColor: null,
          logging: false,
          useCORS: true
        });
        
        const link = document.createElement('a');
        link.download = `code-snap-${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      } catch (err) {
        console.error("Export failed:", err);
        alert("Failed to export image. Please try again.");
      }
    }
    setIsExporting(false);
  };

  const CodeEditor = () => {
    const handleKeyDown = (e) => {
      if (e.key === 'Tab') {
        e.preventDefault();
        const start = e.target.selectionStart;
        const end = e.target.selectionEnd;
        const newCode = code.substring(0, start) + '  ' + code.substring(end);
        setCode(newCode);
        setTimeout(() => {
          e.target.selectionStart = e.target.selectionEnd = start + 2;
        }, 0);
      }
    };

    return (
      <div className="relative min-h-[100px] font-mono text-sm md:text-base leading-6">
        {/* Syntax Highlighted Layer (Visuals) */}
        <pre 
          aria-hidden="true" 
          className={`language-${language} m-0 p-0 bg-transparent overflow-hidden pointer-events-none min-h-full`}
          style={{ 
            fontFamily: '"Fira Code", monospace', 
            margin: 0, 
            padding: 0, 
            background: 'transparent',
            whiteSpace: 'pre-wrap',
            wordBreak: 'break-all',
            // Prism overrides
            textShadow: 'none'
          }}
        >
          <code className={`language-${language}`}>
            {code}
          </code>
        </pre>

        {/* Editable Layer (Interaction) */}
        <textarea
          value={code}
          onChange={(e) => setCode(e.target.value)}
          onKeyDown={handleKeyDown}
          spellCheck="false"
          className="absolute inset-0 w-full h-full resize-none bg-transparent text-transparent caret-white outline-none p-0 m-0 overflow-hidden"
          style={{ 
            fontFamily: '"Fira Code", monospace',
            whiteSpace: 'pre-wrap',
            wordBreak: 'break-all',
            color: 'transparent',
            WebkitTextFillColor: 'transparent',
          }}
        />
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-neutral-900 text-white font-sans selection:bg-pink-500 selection:text-white flex flex-col md:flex-row">
      
      {/* --- Sidebar Controls --- */}
      <div className="w-full md:w-80 bg-neutral-800 border-r border-neutral-700 flex flex-col h-auto md:h-screen sticky top-0 z-20 overflow-y-auto">
        <div className="p-6 border-b border-neutral-700 flex items-center gap-3">
          <div className="w-8 h-8 bg-gradient-to-tr from-pink-500 to-violet-500 rounded-lg flex items-center justify-center text-white">
            <Icons.Camera />
          </div>
          <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-400 to-violet-400">
            CodeSnap
          </h1>
        </div>

        <div className="p-6 space-y-8">
          {/* Language Selector */}
          <div className="space-y-3">
            <label className="flex items-center gap-2 text-sm font-medium text-neutral-400">
              <Icons.Code />
              Language
            </label>
            <div className="relative">
              <select 
                value={language} 
                onChange={(e) => setLanguage(e.target.value)}
                className="w-full bg-neutral-900 border border-neutral-700 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-pink-500 focus:border-transparent outline-none appearance-none transition-all hover:border-neutral-600 cursor-pointer"
              >
                {languages.map(lang => (
                  <option key={lang.id} value={lang.id}>{lang.name}</option>
                ))}
              </select>
              <div className="absolute right-3 top-3 pointer-events-none text-neutral-500">
                <Icons.ChevronDown />
              </div>
            </div>
          </div>

          {/* Theme Selector */}
          <div className="space-y-3">
            <label className="flex items-center gap-2 text-sm font-medium text-neutral-400">
              <Icons.Palette />
              Background
            </label>
            <div className="grid grid-cols-3 gap-2">
              {backgrounds.map((bg) => (
                <button
                  key={bg.name}
                  onClick={() => setBackground(bg.class)}
                  className={`h-10 rounded-md transition-all duration-200 border-2 overflow-hidden relative group ${background === bg.class ? 'border-white scale-105 shadow-lg' : 'border-transparent hover:scale-105'}`}
                  title={bg.name}
                >
                  <div className={`w-full h-full ${bg.class}`}></div>
                </button>
              ))}
            </div>
          </div>

          {/* Padding & Settings */}
          <div className="space-y-3">
            <label className="flex items-center gap-2 text-sm font-medium text-neutral-400">
              <Icons.Layout />
              Padding
            </label>
            <div className="flex bg-neutral-900 p-1 rounded-lg border border-neutral-700">
              {paddings.map((p) => (
                <button
                  key={p.name}
                  onClick={() => setPadding(p.class)}
                  className={`flex-1 text-xs py-1.5 rounded-md transition-all ${padding === p.class ? 'bg-neutral-700 text-white font-medium' : 'text-neutral-500 hover:text-neutral-300'}`}
                >
                  {p.name}
                </button>
              ))}
            </div>
          </div>

          <div className="space-y-3">
            <label className="flex items-center gap-2 text-sm font-medium text-neutral-400">
              <Icons.Type />
              Window Title
            </label>
            <input 
              type="text" 
              value={title} 
              onChange={(e) => setTitle(e.target.value)}
              className="w-full bg-neutral-900 border border-neutral-700 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-pink-500 focus:border-transparent outline-none transition-all"
              placeholder="App.js"
            />
          </div>

           {/* Export Action */}
           <div className="pt-4 border-t border-neutral-800">
             <button 
               onClick={handleExport}
               disabled={isExporting || !scriptsLoaded}
               className="w-full bg-white text-black hover:bg-neutral-200 active:bg-neutral-300 font-bold py-3 rounded-lg flex items-center justify-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed group"
             >
               {isExporting ? (
                 <Icons.Loader />
               ) : (
                 <>
                   <Icons.Download />
                   Export PNG
                 </>
               )}
             </button>
             {!scriptsLoaded && (
               <p className="text-xs text-center mt-2 text-neutral-500">Loading resources...</p>
             )}
           </div>
        </div>
      </div>

      {/* --- Main Preview Area --- */}
      <div className="flex-1 bg-neutral-950 overflow-hidden flex flex-col relative">
        {/* Grid Background Pattern */}
        <div className="absolute inset-0 z-0 opacity-20 pointer-events-none" 
             style={{ 
               backgroundImage: 'linear-gradient(#333 1px, transparent 1px), linear-gradient(90deg, #333 1px, transparent 1px)', 
               backgroundSize: '20px 20px' 
             }}>
        </div>

        {/* Workspace */}
        <div className="flex-1 overflow-auto flex items-center justify-center p-4 md:p-10 z-10">
          
          {/* Capture Target: This is what gets screenshotted */}
          <div 
            ref={captureRef}
            className={`transition-all duration-500 ease-in-out ${background} ${padding} shadow-2xl min-w-[350px] max-w-4xl rounded-xl`}
          >
            {/* The "Glass" Window */}
            <div 
              className={`
                rounded-lg overflow-hidden shadow-2xl backdrop-blur-xl transition-colors duration-300
                ${darkMode ? 'bg-slate-900/90 border border-slate-700/50' : 'bg-white/90 border border-white/50'}
              `}
            >
              {/* Window Header */}
              <div className="px-5 py-4 flex items-center justify-between border-b border-white/10 select-none">
                <div className="flex gap-2">
                  <div className="w-3 h-3 rounded-full bg-red-500/80 hover:bg-red-500 transition-colors shadow-sm"></div>
                  <div className="w-3 h-3 rounded-full bg-yellow-500/80 hover:bg-yellow-500 transition-colors shadow-sm"></div>
                  <div className="w-3 h-3 rounded-full bg-green-500/80 hover:bg-green-500 transition-colors shadow-sm"></div>
                </div>
                
                <div className="absolute left-1/2 -translate-x-1/2 flex items-center gap-2 opacity-60">
                  <span className={`text-xs font-medium tracking-wide ${darkMode ? 'text-slate-300' : 'text-slate-600'}`}>
                    {title}
                  </span>
                </div>

                <div className="flex items-center gap-3">
                   {/* Language Badge */}
                   <div className={`text-[10px] uppercase font-bold tracking-wider px-2 py-0.5 rounded border ${darkMode ? 'border-slate-600 text-slate-400 bg-slate-800/50' : 'border-slate-300 text-slate-500 bg-slate-100/50'}`}>
                     {languages.find(l => l.id === language)?.name || language}
                   </div>
                </div>
              </div>

              {/* Window Body (Code Editor) */}
              <div className="p-6 overflow-x-auto">
                <CodeEditor />
              </div>
            </div>
          </div>

        </div>
        
        {/* Helper Hint */}
        <div className="absolute bottom-6 left-1/2 -translate-x-1/2 z-10 pointer-events-none opacity-50">
           <p className="text-xs text-neutral-400 flex items-center gap-2">
             <span className="bg-neutral-800 px-2 py-1 rounded border border-neutral-700">Tab</span> to indent
           </p>
        </div>

      </div>

      {/* External CSS */}
      <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
      <style>{`
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* Prism Force Overrides */
        code[class*="language-"], pre[class*="language-"] {
          text-shadow: none !important;
          font-family: 'Fira Code', monospace !important;
          font-size: 14px;
          line-height: 1.6;
          direction: ltr;
          text-align: left;
          white-space: pre;
          word-spacing: normal;
          word-break: normal;
          tab-size: 2;
          hyphens: none;
        }

        /* Ensure editor selection is visible */
        textarea::selection {
            background-color: rgba(236, 72, 153, 0.3); /* Pink-500 with opacity */
            color: transparent;
        }
      `}</style>
      <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet" />
    </div>
  );
};

const root = createRoot(document.getElementById('root'));
root.render(<App />);


